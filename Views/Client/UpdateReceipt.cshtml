@model Hospital_simple.Models.ReceiptModel
@{
    ViewData["Title"] = "Update Receipt";
}

<h2 class="text-center">@ViewData["Title"]</h2>

<div class="glass-container p-3">
    <form asp-action="UpdateReceipt" method="post">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="ReceiptID" />
        <input type="hidden" asp-for="ConsultationID" />

        <div class="row mb-3">
            <div class="col-md-4"><strong>Patient:</strong> @Model.PatientName</div>
            <div class="col-md-4"><strong>Doctor:</strong> @Model.DoctorName</div>
            <div class="col-md-4"><strong>Disease:</strong> @Model.Disease</div>
        </div>

        <hr />

        <div class="d-flex align-items-center gap-3 mb-3">
            <h4 class="mb-0">Prescribed Medicines</h4>
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="addMedicineRow()">
                <i class="bi bi-plus-lg"></i> Add Medicine
            </button>
        </div>

        @if (!Model.Medicines.Any())
        {
            <p id="no-meds-msg">No medicines are currently on this receipt.</p>
        }

        <div id="medicine-container">
            @for (int i = 0; i < Model.Medicines.Count; i++)
            {
                <div class="row g-3 mb-3 align-items-end p-3 border rounded glass-container">
                    <input type="hidden" asp-for="Medicines[i].ReceiptMedicineID" />

                    <div class="col-md-4">
                        <div class="form-floating">
                            <select asp-for="Medicines[i].Medicine.MedicineID" class="form-select"
                                    asp-items="@(new SelectList(ViewBag.Medicines, "Value", "Text", Model.Medicines[i].Medicine.MedicineID))">
                            </select>
                            <label>Medicine</label>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-floating">
                            <input type="number" asp-for="Medicines[i].Quantity" class="form-control" placeholder="Quantity" />
                            <label>Quantity</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input asp-for="Medicines[i].Dosage" class="form-control" placeholder="Dosage" />
                            <label>Dosage</label>
                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="d-flex gap-2 flex-wrap mt-3">
            <button type="submit" class="btn btn-primary">Update Medicines</button>
            <a asp-action="ManageReceipts" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<div id="new-medicine-template" style="display: none;">
    <div class="row g-3 mb-3 align-items-end p-3 border rounded glass-container">
        <input type="hidden" name="Medicines[__INDEX__].ReceiptMedicineID" value="0" />

        <div class="col-md-4">
            <div class="form-floating">
                <select name="Medicines[__INDEX__].Medicine.MedicineID" class="form-select">
                    <option value="">-- Select Medicine --</option>
                    @if (ViewBag.Medicines != null)
                    {
                        foreach (var item in (IEnumerable<SelectListItem>)ViewBag.Medicines)
                        {
                            <option value="@item.Value">@item.Text</option>
                        }
                    }
                </select>
                <label>Medicine</label>
            </div>
        </div>
        <div class="col-md-2">
            <div class="form-floating">
                <input type="number" name="Medicines[__INDEX__].Quantity" class="form-control" placeholder="Quantity" value="1" />
                <label>Quantity</label>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-floating">
                <input type="text" name="Medicines[__INDEX__].Dosage" class="form-control" placeholder="Dosage" />
                <label>Dosage</label>
            </div>
        </div>
    </div>
</div>

<script>
    function addMedicineRow() {
        var container = document.getElementById("medicine-container");
        var template = document.getElementById("new-medicine-template").innerHTML;
        var noMedsMsg = document.getElementById("no-meds-msg");

        // Calculate index based on current rows
        var currentIndex = container.querySelectorAll('.glass-container').length;

        // Replace placeholder index
        var newHtml = template.replace(/__INDEX__/g, currentIndex);

        // Create temp element and append
        var tempDiv = document.createElement('div');
        tempDiv.innerHTML = newHtml;
        container.appendChild(tempDiv.firstElementChild);

        // Hide empty message if shown
        if(noMedsMsg) noMedsMsg.style.display = 'none';
    }
</script>